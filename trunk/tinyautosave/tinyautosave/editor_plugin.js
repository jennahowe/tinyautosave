(function(){var d="2.0",a="tinyautosave",B=false,x=false,y=false,m={"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},C={"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},h=[],q={},k="TinyAutoSave_Test_",n={dataKey:"TinyAutoSave",cookieFilter:null,saveDelegate:null,saveFinalDelegate:null,restoreDelegate:null,disposeDelegate:null,restoreImage:"",progressImage:"progress.gif",intervalSeconds:60,retentionMinutes:20,minSaveLength:50,canRestore:false,busy:false,timer:null};try{localStorage.setItem(k,"OK");if(localStorage.getItem(k)==="OK"){localStorage.removeItem(k);B=true}}catch(v){try{sessionStorage.setItem(k,"OK");if(sessionStorage.getItem(k)==="OK"){sessionStorage.removeItem(k);x=true}}catch(v){y=tinymce.isIE}}tinymce.PluginManager.requireLangPack(a);tinymce.create("tinymce.plugins.TinyAutoSavePlugin",{editor:null,url:"",key:"",onPreSave:null,onPostSave:null,onSaveError:null,onPreRestore:null,onPostRestore:null,onRestoreError:null,showSaveProgress:true,progressDisplayTime:1200,init:function(e,D){var E=this,G=tinymce.is,J=tinymce.resolve,F,I,H;if(y){e.getElement().style.behavior="url('#default#userData')"}E.editor=e;E.id=e.id;E.url=D;E.key=e.getParam(a+"_key",e.id);F=A(E);F.restoreImage=D+"/images/restore."+(tinymce.isIE6?"gif":"png");E.setProgressImage(D+"/images/"+n.progressImage);F.intervalSeconds=Math.max(1,parseInt(e.getParam(a+"_interval_seconds",null)||e.getParam(a+"_interval",F.intervalSeconds)));F.retentionMinutes=Math.max(1,parseInt(e.getParam(a+"_retention_minutes",null)||e.getParam(a+"_retention",F.retentionMinutes)));F.minSaveLength=Math.max(1,parseInt(e.getParam(a+"_minlength",F.minSaveLength)));E.showSaveProgress=e.getParam(a+"_showsaveprogress",E.showSaveProgress);F.canRestore=E.hasSavedContent();F.saveDelegate=l(E,t);F.saveFinalDelegate=l(E,g);F.restoreDelegate=l(E,s);e.addCommand("mceTinyAutoSave",F.saveDelegate);e.addCommand("mceTinyAutoSaveRestore",F.restoreDelegate);e.addButton(a,{title:a+".restore_content",cmd:"mceTinyAutoSaveRestore",image:F.restoreImage});F.timer=window.setInterval(F.saveDelegate,F.intervalSeconds*1000);tinymce.dom.Event.add(window,"beforeunload",F.saveFinalDelegate);e.onRemove.add(F.saveFinalDelegate);e.onPostRender.add(function(L,K){L.controlManager.setDisabled(a,!F.canRestore)});I=e.getParam(a+"_oninit",null);if(G(I,"string")){H=J(I);if(G(H,"function")){H.apply(E)}}},getInfo:function(){return{longname:"TinyAutoSave",author:"Speednet",authorurl:"http://www.speednet.biz/",infourl:"http://tinyautosave.googlecode.com/",version:d}},clear:function(){var D=this,e=D.editor,E=c(D);if(B){localStorage.removeItem(E.dataKey)}else{if(x){sessionStorage.removeItem(E.dataKey)}else{if(y){w(D)}else{tinymce.util.Cookie.remove(E.dataKey)}}}E.canRestore=false;e.controlManager.setDisabled(a,D)},hasSavedContent:function(){var F=this,G=c(F),D=new Date(),H,E;try{if(B||x){H=((B?localStorage.getItem(G.dataKey):sessionStorage.getItem(G.dataKey))||"").toString(),E=H.indexOf(",");if((E>8)&&(E<H.length-1)){if((new Date(H.slice(0,E)))>D){return true}if(B){localStorage.removeItem(G.dataKey)}else{sessionStorage.removeItem(G.dataKey)}}return false}else{if(y){return((j(F)||"").length>0)}}return((tinymce.util.Cookie.get(G.dataKey)||"").length>0)}catch(I){return false}},setProgressImage:function(e){if(tinymce.is(e,"string")){b(c(this).progressImage=e)}}});function z(){var e=this,D=c(e);if(D.timer){window.clearInterval(D.timer)}tinymce.dom.Event.remove(window,"beforeunload",D.saveFinalDelegate);e.editor.onRemove.remove(D.saveFinalDelegate);i(e)}function g(){var e=c(this);e.saveDelegate();e.disposeDelegate()}function t(){var P=this,I=P.editor,Q=c(P),H=tinymce.is,E=I.execCallback,O=false,D=new Date(),K,F,M,L,N,G;if((I)&&(!Q.busy)){Q.busy=true;if(H(P.onPreSave,"string")){if(!E(P.onPreSave)){Q.busy=false;return false}}K=I.getContent();if(H(K,"string")&&(K.length>=Q.minSaveLength)){F=new Date(D.getTime()+(Q.retentionMinutes*60*1000));try{if(B){localStorage.setItem(Q.dataKey,F.toString()+","+f(K))}else{if(x){sessionStorage.setItem(Q.dataKey,F.toString()+","+f(K))}else{if(y){p(P,K,F)}else{M=Q.dataKey+"=";L="; expires="+F.toUTCString();document.cookie=M+r(K).slice(0,4096-M.length-L.length)+L}}}O=true}catch(J){if(H(P.onSaveError,"string")){E(P.onSaveError)}}if(O){N=I.controlManager;Q.canRestore=true;N.setDisabled(a,false);if(P.showSaveProgress){L=tinymce.DOM.get(N.get(a).id);G=Q.restoreImage;L.firstChild.src=Q.progressImage;window.setTimeout(function(){L.firstChild.src=G},Math.min(P.progressDisplayTime,Q.intervalSeconds*1000-100))}if(H(P.onPostSave,"string")){E(P.onPostSave)}}}Q.busy=false}return O}function s(){var K=this,H=K.editor,L=c(K),J=null,G=tinymce.is,D=H.execCallback,F,E;if((H)&&(L.canRestore)&&(!L.busy)){L.busy=true;if(G(K.onPreRestore,"string")){if(!D(K.onPreRestore)){L.busy=false;return}}try{if(B||x){J=((B?localStorage.getItem(L.dataKey):sessionStorage.getItem(L.dataKey))||"").toString();F=J.indexOf(",");if(F==-1){J=null}else{J=o(J.slice(F+1,J.length))}}else{if(y){J=j(K)}else{E=L.cookieFilter.exec(document.cookie);if(E){J=u(E[1])}}}if(!G(J,"string")){H.windowManager.alert(a+".no_content")}else{if(H.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length===0){H.setContent(J);if(G(K.onPostRestore,"string")){D(K.onPostRestore)}}else{H.windowManager.confirm(a+".warning_message",function(e){if(e){H.setContent(J);if(G(K.onPostRestore,"string")){D(K.onPostRestore)}}L.busy=false},K)}}}catch(I){if(G(K.onRestoreError,"string")){D(K.onRestoreError)}}L.busy=false}}function p(E,G,F){var e=E.editor.getElement(),D=c(E);e.setAttribute(D.dataKey,G);e.expires=F.toUTCString();e.save("TinyMCE")}function j(D){var e=D.editor.getElement();e.load("TinyMCE");return e.getAttribute(c(D).dataKey)}function w(e){e.editor.getElement().removeAttribute(c(e).dataKey)}function r(e){return e.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(D){if(D.length>1){return("%0"+D.charAt(0)+D.length.toString()+"%")}return m[D]})}function u(e){return e.replace(/%[1-5]|%0(.)(\d+)%/g,function(I,D,H){var F,G,E;if(I.length==2){return C[I]}for(F=[],G=0,E=parseInt(H);G<E;G++){F.push(D)}return F.join("")})}function f(e){return e.replace(/,/g,"&#44;")}function o(e){return e.replace(/&#44;/g,",")}function b(D){var e=h.length;h[e]=new Image();h[e].src=D}function l(e,D){return function(){return D.apply(e)}}function A(E){var e=E.key,D=q[e];if(!D){D=q[e]=tinymce.extend({},n,{dataKey:n.dataKey+e,saveDelegate:l(E,t),saveFinalDelegate:l(E,g),restoreDelegate:l(E,s),disposeDelegate:l(E,z),cookieFilter:new RegExp("(?:^|;\\s*)"+n.dataKey+e+"=([^;]*)(?:;|$)","i")})}return D}function c(e){return q[e.key]}function i(e){delete q[e.key]}tinymce.PluginManager.add(a,tinymce.plugins.TinyAutoSavePlugin)})();