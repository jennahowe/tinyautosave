(function(){tinymce.PluginManager.requireLangPack("tinyautosave");tinymce.create("tinymce.plugins.TinyAutoSavePlugin",{editor:null,url:"",onPreSave:null,onPostSave:null,onSaveError:null,onPreRestore:null,onPostRestore:null,onRestoreError:null,showSaveProgress:true,__save:null,__saveFinal:null,__restore:null,__dispose:null,_cookieName:"tinyautosave",_restoreImage:"",_progressImage:"",_intervalSeconds:60,_retentionMinutes:20,_minLength:50,_canRestore:false,_busy:false,_useLocalStorage:false,_useSessionStorage:false,_useUserData:false,_timer:null,init:function(c,d){function createDelegate(a,b){return function(){return b.apply(a,arguments)}}var t=this;if(!(t._useLocalStorage=((typeof(localStorage)==="object")&&(!!localStorage.getItem)&&(!!localStorage.setItem)&&(!!localStorage.removeItem)))){if(!(t._useSessionStorage=((typeof(sessionStorage)==="object")&&(!!sessionStorage.getItem)&&(!!sessionStorage.setItem)&&(!!sessionStorage.removeItem)))){if(t._useUserData=tinymce.isIE){c.getElement().style.behavior="url('#default#userData')"}}}t.editor=c;t.url=d;t._cookieName="tinyautosave_"+c.id;t._restoreImage=d+"/images/restore."+(tinymce.isIE6?"gif":"png");t._progressImage=d+"/images/progress.gif";t._intervalSeconds=Math.max(1,parseInt(c.getParam("tinyautosave_interval_seconds",null)||c.getParam("tinyautosave_interval",t._intervalSeconds)));t._retentionMinutes=Math.max(1,parseInt(c.getParam("tinyautosave_retention_minutes",null)||c.getParam("tinyautosave_retention",t._retentionMinutes)));t._minLength=Math.max(1,parseInt(c.getParam("tinyautosave_minlength",t._minLength)));t.showSaveProgress=c.getParam("tinyautosave_showsaveprogress",t.showSaveProgress);t._canRestore=t.hasSavedContent();t.__save=createDelegate(t,t._save);t.__saveFinal=createDelegate(t,t._saveFinal);t.__restore=createDelegate(t,t._restore);t.__dispose=createDelegate(t,t._dispose);c.addCommand("mceTinyAutoSave",t.__save);c.addCommand("mceTinyAutoSaveRestore",t.__restore);c.addButton("tinyautosave",{title:"tinyautosave.restore_content",cmd:"mceTinyAutoSaveRestore",image:t._restoreImage});t._timer=window.setInterval(t.__save,t._intervalSeconds*1000);tinymce.dom.Event.add(window,"beforeunload",t.__saveFinal);c.onRemove.add(t.__saveFinal);c.onPostRender.add(function(a,b){a.controlManager.setDisabled('tinyautosave',!t._canRestore)})},getInfo:function(){return{longname:"TinyAutoSave",author:"Speednet",authorurl:"http://www.speednet.biz/",infourl:"http://tinyautosave.googlecode.com/",version:"1.1"}},clear:function(){var a=this.editor,now=new Date();if(this._useLocalStorage){localStorage.removeItem("TinyAutoSave")}else if(this._useSessionStorage){sessionStorage.removeItem("TinyAutoSave")}else if(this._useUserData){this._removeUserData(a)}else{tinymce.util.Cookie.remove(this._cookieName)}this._canRestore=false;a.controlManager.setDisabled('tinyautosave',true)},hasSavedContent:function(){if(this._useLocalStorage||this._useSessionStorage){var a=new Date();var b=((this._useLocalStorage?localStorage.getItem("TinyAutoSave"):sessionStorage.getItem("TinyAutoSave"))||"").toString();var i=b.indexOf(",");if((i>8)&&(i<b.length-1)){if((new Date(b.slice(0,i)))>a){return true}if(this._useLocalStorage){localStorage.removeItem("TinyAutoSave")}else{sessionStorage.removeItem("TinyAutoSave")}}return false}else if(this._useUserData){return((this._getUserData(this.editor)||"").length>0)}return((tinymce.util.Cookie.get(this._cookieName)||"").length>0)},_saveFinal:function(){this._save();this._dispose()},_save:function(){var t=this,ed=t.editor,is=tinymce.is,execCallback=ed.execCallback,saved=false,now=new Date();if((ed)&&(!t._busy)){t._busy=true;if(is(t.onPreSave,"string")){if(!execCallback(t.onPreSave)){t._busy=false;return false}}var c=ed.getContent();if(is(c,"string")&&(c.length>=t._minLength)){var d=new Date(now.getTime()+(t._retentionMinutes*60*1000));try{if(t._useLocalStorage){localStorage.setItem("TinyAutoSave",d.toString()+","+t._encodeStorage(c))}else if(t._useSessionStorage){sessionStorage.setItem("TinyAutoSave",d.toString()+","+t._encodeStorage(c))}else if(t._useUserData){t._setUserData(ed,c,d)}else{var a=t._cookieName+"=";var b="; expires="+d.toUTCString();document.cookie=a+t._encodeCookie(c).slice(0,4096-a.length-b.length)+b}saved=true}catch(e){if(is(t.onSaveError,"string")){execCallback(t.onSaveError)}}if(saved){var f=ed.controlManager;t._canRestore=true;f.setDisabled('tinyautosave',false);if(t.showSaveProgress){var b=tinymce.DOM.get(f.get('tinyautosave').id),restoreImage=t._restoreImage;b.children[0].src=t._progressImage;window.setTimeout(function(){b.children[0].src=restoreImage},1200)}if(is(t.onPostSave,"string")){execCallback(t.onPostSave)}}}t._busy=false}return saved},_cookieFilter:null,_restore:function(){var t=this,ed=t.editor,content=null,is=tinymce.is,execCallback=ed.execCallback;if((ed)&&(t._canRestore)&&(!t._busy)){t._busy=true;if(is(t.onPreRestore,"string")){if(!execCallback(t.onPreRestore)){t._busy=false;return}}try{if(t._useLocalStorage||t._useSessionStorage){content=((t._useLocalStorage?localStorage.getItem("TinyAutoSave"):sessionStorage.getItem("TinyAutoSave"))||"").toString();var i=content.indexOf(",");if(i==-1){content=null}else{content=t._decodeStorage(content.slice(i+1,content.length))}}else if(t._useUserData){content=t._getUserData(ed)}else{if(t._cookieFilter==null){t._cookieFilter=new RegExp("(?:^|;\\s*)"+t._cookieName+"=([^;]*)(?:;|$)","i")}var m=t._cookieFilter.exec(document.cookie);if(m){content=t._decodeCookie(m[1])}}if(!is(content,"string")){ed.windowManager.alert("tinyautosave.no_content")}else{if(ed.getContent().replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length==0){ed.setContent(content);if(is(t.onPostRestore,"string")){execCallback(t.onPostRestore)}}else{ed.windowManager.confirm("tinyautosave.warning_message",function(a){if(a){ed.setContent(content);if(is(t.onPostRestore,"string")){execCallback(t.onPostRestore)}}t._busy=false},this)}}}catch(e){if(is(t.onRestoreError,"string")){execCallback(t.onRestoreError)}}t._busy=false}},_setUserData:function(a,b,c){var d=a.getElement();d.setAttribute("tinyautosave",b);d.expires=c.toUTCString();d.save("TinyMCE")},_getUserData:function(a){var b=a.getElement();b.load("TinyMCE");return b.getAttribute("tinyautosave")},_removeUserData:function(a){a.getElement().removeAttribute("tinyautosave",str)},_encodeKey:{"%":"%1","&":"%2",";":"%3","=":"%4","<":"%5"},_decodeKey:{"%1":"%","%2":"&","%3":";","%4":"=","%5":"<"},_encodeCookie:function(a){var k=this._encodeKey;return a.replace(/[\x00-\x1f]+|&nbsp;|&#160;/gi," ").replace(/(.)\1{5,}|[%&;=<]/g,function(c){if(c.length>1){return("%0"+c.charAt(0)+c.length.toString()+"%")}return k[c]})},_decodeCookie:function(b){var k=this._decodeKey;return b.replace(/%[1-5]|%0(.)(\d+)%/g,function(c,m,d){if(c.length==2){return k[c]}for(var a=[],i=0,l=parseInt(d);i<l;i++){a.push(m)}return a.join("")})},_encodeStorage:function(a){return a.replace(/,/g,"&#44;")},_decodeStorage:function(a){return a.replace(/&#44;/g,",")},_dispose:function(){if(this._timer){window.clearInterval(this._timer)}tinymce.dom.Event.remove(window,"beforeunload",this.__saveFinal);this.__save=this.__saveFinal=this.__restore=this.__dispose=this._timer=this._cookieFilter=this._encodeKey=this._decodeKey=null}});tinymce.PluginManager.add("tinyautosave",tinymce.plugins.TinyAutoSavePlugin)})();